name: Update vcpkg Port

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  update-vcpkg-port:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout SDK
        uses: actions/checkout@v4
        
      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Calculate SHA512 of release tarball
        id: get_sha
        run: |
          # Wait for GitHub to create the tarball
          sleep 10
          
          TARBALL_URL="https://github.com/${{ github.repository }}/archive/refs/tags/v${{ steps.get_version.outputs.VERSION }}.tar.gz"
          echo "Downloading: $TARBALL_URL"
          
          SHA512=$(curl -sL "$TARBALL_URL" | sha512sum | cut -d' ' -f1)
          echo "SHA512=$SHA512" >> $GITHUB_OUTPUT
          echo "SHA512: $SHA512"

      - name: Update vcpkg.json version
        run: |
          cd c/vcpkg
          # Update version in vcpkg.json
          jq '.version = "${{ steps.get_version.outputs.VERSION }}"' vcpkg.json > vcpkg.json.tmp
          mv vcpkg.json.tmp vcpkg.json
          cat vcpkg.json

      - name: Update portfile.cmake with SHA512
        run: |
          cd c/vcpkg
          # Update SHA512 in portfile.cmake
          sed -i 's/SHA512 .*/SHA512 ${{ steps.get_sha.outputs.SHA512 }}/' portfile.cmake
          cat portfile.cmake

      - name: Commit updated port files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add c/vcpkg/vcpkg.json c/vcpkg/portfile.cmake
          git commit -m "Update vcpkg port to v${{ steps.get_version.outputs.VERSION }}" || echo "No changes to commit"
          git push origin HEAD:master

  # Optional: Create PR to microsoft/vcpkg
  # Uncomment when ready to publish to the official registry
  #
  # create-vcpkg-pr:
  #   runs-on: ubuntu-latest
  #   needs: update-vcpkg-port
  #   
  #   steps:
  #     - name: Checkout vcpkg
  #       uses: actions/checkout@v4
  #       with:
  #         repository: microsoft/vcpkg
  #         token: ${{ secrets.VCPKG_PAT }}  # Personal Access Token with repo scope
  #         
  #     - name: Checkout SDK port files
  #       uses: actions/checkout@v4
  #       with:
  #         path: sdk
  #         
  #     - name: Extract version
  #       id: get_version
  #       run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
  #       
  #     - name: Copy port files
  #       run: |
  #         mkdir -p ports/json-structure
  #         cp sdk/c/vcpkg/* ports/json-structure/
  #         
  #     - name: Update version database
  #       run: |
  #         ./vcpkg x-add-version json-structure --overwrite-version
  #         
  #     - name: Create Pull Request
  #       uses: peter-evans/create-pull-request@v5
  #       with:
  #         token: ${{ secrets.VCPKG_PAT }}
  #         commit-message: "[json-structure] Update to ${{ steps.get_version.outputs.VERSION }}"
  #         title: "[json-structure] Update to ${{ steps.get_version.outputs.VERSION }}"
  #         body: |
  #           Update json-structure to version ${{ steps.get_version.outputs.VERSION }}
  #           
  #           Upstream release: https://github.com/json-structure/sdk/releases/tag/v${{ steps.get_version.outputs.VERSION }}
  #         branch: json-structure-${{ steps.get_version.outputs.VERSION }}
  #         base: master
